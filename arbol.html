<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="librerias/cytoscape.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cytoscape-automove@1.10.2/cytoscape-automove.min.js"></script>
    <style>
        #cy {
            width: 800px;
            height: 800px;
            display: block;
        }
    </style>

</head>

<body>
    <div id="cy"></div>
    <script>
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms))
        }

        // node class is the basic structure
        // of each node present in the Huffman - tree.
        class NodoHuffman {
            constructor() {
                this.frecuencia = 0;
                this.caracter = '';
                this.izquierda = this.derecha = null;
                this.idCy = '';
            }
        }

        // recursive function to print the
        // huffman-code through the tree traversal.
        // Here stringCodigo is the huffman - code generated.
        function imprimirTablaCodificacion(caracter, stringCodigo) {
            // base case; if the izquierda and derecha are null
            // then its a leaf node and we print
            // the code stringCodigo generated by traversing the tree.
            if (caracter.izquierda == null &&
                caracter.derecha == null &&
                (caracter.caracter).toLowerCase() != (caracter.caracter).toUpperCase()) {

                // caracter is the character in the node
                document.write(caracter.caracter + ":" + stringCodigo + "<br>");

                return;
            }

            // if we go to izquierda then add "0" to the code.
            // if we go to the derecha add"1" to the code.

            // recursive calls for izquierda and
            // derecha sub-tree of the generated tree.
            imprimirTablaCodificacion(caracter.izquierda, stringCodigo + "0");
            imprimirTablaCodificacion(caracter.derecha, stringCodigo + "1");
        }

        // main function  
        // number of characters.
        /**
        
        let n = 6;
        let charArray = ['f', 'e', 'c', 'b', 'd', 'a'];
        let charfreq = [5, 9, 12, 13, 16, 46];

        let n = 7;
        let charArray = ['_', 'a', 'i', 'l', 'n', 't', 'v'];
        let charfreq = [3, 6, 2, 2, 2, 2, 1];
        **/

        let n = 7;
        let charArray = ['_', 'a', 'i', 'l', 'n', 't', 'v'];
        let charfreq = [3, 6, 2, 2, 2, 2, 1];

        // creating a priority queue colaPrioridad.
        // makes a min-priority queue(min-heap).
        let colaPrioridad = [];

        for (let i = 0; i < n; i++) {

            // creating a Huffman node object
            // and add it to the priority queue.
            let hn = new NodoHuffman();

            hn.caracter = charArray[i];
            hn.frecuencia = charfreq[i];

            hn.idCy = `${hn.caracter}-${hn.frecuencia}`;

            hn.izquierda = null;
            hn.derecha = null;

            // add functions adds
            // the huffman node to the queue.
            colaPrioridad.push(hn);
        }

        colaPrioridad.sort(function(a, b) {
            return a.frecuencia - b.frecuencia;
        });



        let cy = cytoscape({

            container: document.getElementById('cy'), // container to render in

            elements: [ // list of graph elements to start with

            ],

            style: [ // the stylesheet for the graph
                {
                    selector: 'node',
                    style: {
                        'background-color': '#11479e',
                        'text-wrap': 'wrap',
                        'text-halign': 'center',
                        'text-valign': 'center',
                        'color': '#fff'
                    }
                },

                {
                    selector: 'edge',
                    style: {
                        'width': 3,
                        'line-color': '#ccc',
                        'target-arrow-color': '#ccc',
                        'target-arrow-shape': 'triangle',
                        'curve-style': 'bezier'
                    }
                }
            ],

            layout: {
                name: 'grid',
                rows: 1
            }

        });

        //crea los nodos de la cola de prioridad
        let i = 1;
        colaPrioridad.forEach(nodoHuffman => {
            cy.add({
                data: {
                    id: nodoHuffman.idCy,
                },
                position: {
                    x: 100 * i,
                    y: 200
                }
            }).css({
                'label': `${nodoHuffman.caracter} (${nodoHuffman.frecuencia})`
            })
            i++;
        });

        let posicionNuevoNodo = 50;

        function animarWhile(idNodoUno, idNodoDos, idNuevoArbol, sumaFrecuencia) {
            //obtiene un el primer nodo
            let nodo1 = cy.getElementById(idNodoUno);
            let posicionOriginal = nodo1.position('x');
            let i = 100;
            let esHoja = cy.$(`.${idNodoUno}`).length == 0;
            setTimeout(function() {
                if (esHoja) { //si el nodo es hoja se ejecuta la animacion de hoja
                    console.log('hoja');
                    nodo1.addClass(idNuevoArbol);
                    nodo1.animate({
                        position: {
                            x: nodo1.position('x'),
                            y: 400
                        },
                        style: {
                            lineColor: 'pink'
                        }
                    }, {
                        duration: 1000,
                    });

                } else { //en caso contrario, se ejecuta la animacion de arbol
                    console.log('arbol');
                    let arbol = cy.$(`.${idNodoUno}`);
                    arbol.forEach((nodo) => nodo.addClass(idNuevoArbol)); //actualizamos la nueva clase para que podamos moverlo
                    arbol.layout({
                        name: 'preset',
                        animate: true,
                        fit: false,
                        transform: (nodo) => {
                            let position = {};
                            position.x = nodo.position('x');
                            position.y = nodo.position('y') + 200;
                            i += 50;
                            return position;
                        }
                    }).run();

                }
            }, 1000);

            console.log(posicionOriginal);


            //obtiene el segundo nodo
            let nodo2 = cy.getElementById(idNodoDos);
            i = 50;
            setTimeout(function() {
                if (cy.$(`.${idNodoDos}`).length == 0) { //si el nodo es hoja se ejecuta la animacion de hoja
                    console.log('hoja');
                    nodo2.addClass(idNuevoArbol);
                    nodo2.animate({
                        position: {
                            x: nodo2.position('x'),
                            y: 400
                        },
                        style: {
                            lineColor: 'pink'
                        }
                    }, {
                        duration: 1000,
                    });

                } else { //en caso contrario, se ejecuta la animacion de arbol
                    console.log('arbol');
                    let arbol = cy.$(`.${idNodoDos}`);
                    arbol.forEach((nodo) => nodo.addClass(idNuevoArbol)); //actualizamos la nueva clase para que podamos moverlo
                    arbol.layout({
                        name: 'preset',
                        animate: true,
                        fit: false,
                        transform: (nodo) => {
                            let position = {};
                            position.x = nodo.position('x');
                            position.y = nodo.position('y') + 200;
                            i += 70;
                            return position;
                        }
                    }).run();

                }
            }, 1000);





            //agregamos nodo de huffman
            setTimeout(function() {
                cy.add({
                    data: {
                        id: idNuevoArbol,
                    },
                    position: {
                        x: nodo1.position('x') + posicionNuevoNodo,
                        y: nodo1.position('y') - 100
                    }
                }).addClass(idNuevoArbol).css({
                    'label': `(${sumaFrecuencia})`
                });
                !esHoja ? posicionNuevoNodo += 50 : posicionNuevoNodo;
            }, 2000);




            //agregamos izquierda
            setTimeout(function() {
                cy.add({
                    data: {
                        id: `.${idNuevoArbol}-izq`,
                        source: idNuevoArbol,
                        target: idNodoUno
                    }
                });
            }, 3000);


            //agregamos derecha
            setTimeout(function() {
                cy.add({
                    data: {
                        id: `.${idNuevoArbol}-der`,
                        source: idNuevoArbol,
                        target: idNodoDos
                    }
                });
            }, 4000);




            setTimeout(function() {
                let arbol = cy.$(`.${idNuevoArbol}`);
                arbol.layout({
                    name: 'preset',
                    animate: true,
                    fit: false,
                    transform: (nodo) => {
                        let position = {};
                        position.x = nodo.position('x'); //colaPrioridad.length 

                        position.y = nodo.position('y') - 100;
                        return position;
                    }
                }).run();
            }, 5000);
        }


        async function whileHuffman(colaPrioridad) {
            let iteraciones = 0;
            while (colaPrioridad.length > 1) {
                let nodoUno = colaPrioridad.shift();
                let nodoDos = colaPrioridad.shift();

                let nuevoArbol = new NodoHuffman();
                nuevoArbol.frecuencia = nodoUno.frecuencia + nodoDos.frecuencia;
                nuevoArbol.caracter = undefined;


                nuevoArbol.izquierda = nodoUno;
                nuevoArbol.derecha = nodoDos;

                nuevoArbol.idCy = `it-${iteraciones}-${nodoUno.frecuencia}-${nodoDos.frecuencia}`

                colaPrioridad.push(nuevoArbol);

                animarWhile(nodoUno.idCy, nodoDos.idCy, nuevoArbol.idCy, nuevoArbol.frecuencia);
                await sleep(5000);
                colaPrioridad.sort(function(a, b) {
                    return a.frecuencia - b.frecuencia;
                });
                iteraciones++;
                /*cy.fit();
                cy.center();*/
            }
        }

        whileHuffman(colaPrioridad);



        // This code is contributed by avanitrachhadiya2155
    </script>
</body>

</html>